<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="./js/vue.js"></script>
    <link rel="stylesheet" type="text/css" href="./index.css" />
    <title>tic-tac-toe</title>
    <style>
      .body {
        font-size: medium;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="game">
        <div class="game-board">
          <div class="board-row" v-for="(row,index) in board" :key="index">
            <button
              :class="winnersquare[square]"
              v-for="square in row"
              @click="handleChange(square)"
              :key="square"
            >
              {{current[square]}}
            </button>
          </div>
        </div>
        <div class="game-info">
          <p>{{desc}}</p>
          <!-- <div v-html="times"></div> -->
          <div>
            <li v-for="(item,index) in history" :key="index">
              <button @click="jump(index)">
                move {{index}} -- step {{item.step}} --{{parseInt(item.step /
                3)+1}}行{{item.step % 3 + 1}}列
              </button>
            </li>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      function winnerCal(squares) {
        let lists = [
          [0, 1, 2],
          [3, 4, 5],
          [6, 7, 8],
          [0, 4, 8],
          [1, 4, 7],
          [2, 4, 6],
          [2, 5, 8],
          [0, 3, 6],
        ];
        for (let i = 0; i < lists.length; i++) {
          const [a, b, c] = lists[i];
          // console.log("cal", squares);
          if (
            squares[a] &&
            squares[a] === squares[b] &&
            squares[a] === squares[c]
          ) {
            return [lists[i], squares[a]];
          }
        }
      }
      Vue.component("time-machine", {
        props: [],
        template: `
          <div>

          </div>
        `,
      });
      const app = new Vue({
        el: "#app",
        data() {
          return {
            history: [
              {
                squares: Array(9).fill(null),
                step: -1,
              },
            ],
            board: [
              [0, 1, 2],
              [3, 4, 5],
              [6, 7, 8],
            ],
            desc: "",
            xisNext: true,
            times: "",
          };
        },
        computed: {
          current() {
            // console.log("test", this.history);
            return this.history[this.history.length - 1].squares;
          },
          winner() {
            console.log(winnerCal(this.current));
            return winnerCal(this.current);
          },
          step() {
            return this.history[this.history.length - 1].step;
          },
          historys() {
            return this.history[this.history.length - 1];
          },
          winnersquare() {
            let winnersquare = Array(9).fill("square");
            if (this.winner && this.winner[0]) {
              this.winner[0].forEach((item) => {
                winnersquare[item] = "winner-square";
              });
            }
            return winnersquare;
          },
        },
        watch: {
          history: {
            deep: true,
            immediate: true,
            handler(newValue, oldValue) {
              if (this.winner) {
                this.desc = "winner is " + this.winner[1];
              } else if (!this.winner && this.history.length === 10) {
                this.desc = "平局";
              } else {
                this.desc = "Next is " + (this.xisNext ? "X" : "O");
              }
            },
          },
        },
        methods: {
          handleChange(square) {
            if (this.current[square] || this.winner) {
              return;
            }
            // console.log("this", this.winner);
            let history = Object.assign({}, this.historys);
            history.squares = this.current.slice();
            history.squares[square] = this.xisNext ? "X" : "O";
            history.step = square;

            this.history.push(history);
            console.log("test", history);

            // this.$set(this.squares, square, this.xisNext ? "X" : "O");
            this.xisNext = !this.xisNext;
          },
          jump(step) {
            this.history = this.history.slice(0, step + 1);
          },
        },
      });
    </script>
  </body>
</html>
